<!DOCTYPE html>
<html lang="zh-CN">
    
    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
    <meta name="description" content="å®ç°SwiGLUç®—å­" />
    <meta name="hexo-theme-A4" content="v1.9.8" />
    <link rel="alternate icon" type="image/webp" href="/MyBlog/img/favicon.jpg">
    <title>é’å±±ä¾æ—§åœ¨</title>

    
        
<link rel="stylesheet" href="/MyBlog/css/highlight/style1.css">

        
<link rel="stylesheet" href="/MyBlog/css/reset.css">

        
<link rel="stylesheet" href="/MyBlog/css/markdown.css">

        
<link rel="stylesheet" href="/MyBlog/css/fonts.css">
 
         <!--æ³¨æ„ï¼šé¦–é¡µæ—¢ä¸æ˜¯postä¹Ÿä¸æ˜¯page-->
        
        
        
<link rel="stylesheet" href="/MyBlog/css/ui.css">
 
        
<link rel="stylesheet" href="/MyBlog/css/style.css">


        
            <!--è¿”å›é¡¶éƒ¨css-->
            
<link rel="stylesheet" href="/MyBlog/css/returnToTop.css">

            
<link rel="stylesheet" href="/MyBlog/css/unicons.css">

        
        
            <!--ç›®å½•-->
            
<link rel="stylesheet" href="/MyBlog/css/toc.css">

        
    

    
        
<link rel="stylesheet" href="/MyBlog/css/returnToLastPage.css">

    
    
   
<link rel="stylesheet" href="/MyBlog/css/lightgallery-bundle.min.css">


   
        
<link rel="stylesheet" href="/MyBlog/css/custom.css">

    

<meta name="generator" content="Hexo 7.3.0"></head>
    
    

    
    



    

    
    




    <style>
        .archive-main a:hover {
            text-decoration: none; 
        }
    </style>

    
    

    
    <body>
        <script src="/js/darkmode-js.min.js"></script>
        
        <script>
            const options = {
                bottom: '40px', // default: '32px'
                right: 'unset', // default: '32px'
                left: '42px', // default: 'unset'
                time: '0.3s', // default: '0.3s'
                mixColor: '#fff', // default: '#fff'
                backgroundColor: ' #e4e4e4 ',  // default: '#fff'
                buttonColorDark: '#100f2c',  // default: '#100f2c'
                buttonColorLight: '#fff', // default: '#fff'
                saveInCookies: true, // default: true,
                label: 'ğŸŒ“', // default: ''
                autoMatchOsTheme: true // default: true
            }
            const darkmode = new Darkmode(options);
            darkmode.showWidget();
        </script>
        
        
            
                <div class="left-toc-container">
                    <nav id="toc" class="bs-docs-sidebar"></nav>
                </div>
            
        
        <div class="paper">
            
            
            
            
                <div class="shadow-drop-2-bottom paper-main">
                    


<div class="header">
    <div class="header-container">
        <style>
            .header-img {
                width: 56px;
                height: auto;
                object-fit: cover; /* ä¿æŒå›¾ç‰‡æ¯”ä¾‹ */
                transition: transform 0.3s ease-in-out; 
                border-radius: 50%; 
            }
            
            .header-img:hover {
                animation: rotateAnimation 2s linear infinite; /* æ‚¬åœæ—‹è½¬åŠ¨ç”» */
            }
            @keyframes rotateAnimation {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }
            
        </style>
        <img 
            alt="^-^" 
            cache-control="max-age=86400" 
            class="header-img" 
            src="/MyBlog/img/favicon.jpg" 
        />
        <div class="header-content">
            <a class="logo" href="/MyBlog/">é’å±±ä¾æ—§åœ¨</a> 
            <span class="description"></span> 
        </div>
    </div>
    
   
    <ul class="nav">
        
            
                <li><a href="/MyBlog/">é¦–é¡µ</a></li>
            
        
            
                <li><a href="/MyBlog/list/">æ–‡ç« </a></li>
            
        
            
                <li><a href="/MyBlog/about/">å…³äº</a></li>
            
        
            
                <li><a href="/MyBlog/tags/">æ ‡ç­¾</a></li>
            
        
            
                <li><a href="/MyBlog/categories/">åˆ†ç±»</a></li>
            
        
    </ul>
</div> 
        
                    
                    

                    
                    
                    
                    <!--è¯´æ˜æ˜¯æ–‡ç« posté¡µé¢-->
                    
                        <div class="post-main">
    

    
        
            
                <div class="post-main-title" style="text-align: center;">
                    å®ç°SwiGLUç®—å­
                </div>
            
        
      
    

    

        
            <div class="post-head-meta-center">
        
                
                    <span>æœ€è¿‘æ›´æ–°ï¼š2025-02-21</span> 
                
                
                    
                        &nbsp; | &nbsp;
                    
                     <span>å­—æ•°æ€»è®¡ï¼š2.7k</span>
                
                
                    
                        &nbsp; | &nbsp;
                    
                    <span>é˜…è¯»ä¼°æ—¶ï¼š11åˆ†é’Ÿ</span>
                
                
                    
                        &nbsp; | &nbsp;
                    
                    <span id="busuanzi_container_page_pv">
                        é˜…è¯»é‡ï¼š<span id="busuanzi_value_page_pv"></span>æ¬¡
                    </span>
                
            </div>
    

    <div class="post-md">
        
            
                <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%BB%BB%E5%8A%A1%E6%8F%8F%E8%BF%B0"><span class="post-toc-text">ä»»åŠ¡æè¿°</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E8%A7%A3%E8%AF%BB-Tensor"><span class="post-toc-text">è§£è¯» Tensor</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Tensor-%E7%9A%84%E6%96%B9%E6%B3%95"><span class="post-toc-text">Tensor çš„æ–¹æ³•</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#new"><span class="post-toc-text">new()</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#default"><span class="post-toc-text">default()</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#data"><span class="post-toc-text">data()</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#data-mut"><span class="post-toc-text">data_mut()</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#shape"><span class="post-toc-text">shape()</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#size"><span class="post-toc-text">size()</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#reshape"><span class="post-toc-text">reshape()</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#slice"><span class="post-toc-text">slice()</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#close-to"><span class="post-toc-text">close_to()</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#print"><span class="post-toc-text">print()</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#swiglu-%E7%AE%97%E5%AD%90%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="post-toc-text">swiglu ç®—å­çš„å®ç°</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E6%80%BB%E7%BB%93%E6%8A%80%E5%B7%A7"><span class="post-toc-text">æ€»ç»“æŠ€å·§</span></a></li></ol>
            
        
        <div class=".article-gallery"><p>å½“å®Œæˆ <a target="_blank" rel="noopener" href="https://opencamp.cn/InfiniTensor/camp/2024winter">2024å†¬å­£å¤§æ¨¡å‹ä¸äººå·¥æ™ºèƒ½ç³»ç»Ÿè®­ç»ƒè¥</a> çš„ç¼–ç¨‹è¯­è¨€åŸºç¡€ï¼ˆRustï¼‰é˜¶æ®µï¼Œé¢å¯¹ä½œä¸šé˜¶æ®µæ—¶å¤§æ¦‚çœ‹äº†ä¸€çœ¼é¢˜ç›®æè¿°å’Œé¡¹ç›®ä»£ç å®é™…ä¸Šæ˜¯æœ‰ç‚¹æ…Œçš„ã€‚</p>
<p>æ¯”å¦‚ä¸æ˜ç™½å¼ é‡æ˜¯ä»€ä¹ˆï¼Ÿåˆæ¯”å¦‚çœ‹äº† <code>Tensor&lt;T&gt;</code> çš„ <code>data: Arc&lt;Box&lt;T&gt;&gt;</code> å‘ç°åŒæ—¶ä½¿ç”¨è¿™ä¸¤ç§æŒ‡é’ˆæˆ‘åˆæä¸æ˜ç™½äº†ï¼Œä¹‹å‰å­¦ä¹ æ™ºèƒ½æŒ‡é’ˆçš„ä½¿ç”¨æ˜¯æœ‰ç‚¹æµ…äº†ã€‚</p>
<p>äºæ˜¯åˆå›å»å•ƒäº†å‡ å¤© Rust è¯­è¨€éƒ¨åˆ†ï¼Œä½œç”¨å½“ç„¶æ˜¯æœ‰çš„ï¼Œä¸€äº›ä¼¼æ˜¯è€Œéçš„å¼•ç”¨ã€å€Ÿç”¨ã€æ‰€æœ‰æƒçš„æ¦‚å¿µå†æ¬¡å­¦ä¹ å¤§çº¦å°±æ˜ç™½äº†ä¸ƒä¸ƒå…«å…«ã€‚ä½†å¯¹äºé¡¹ç›®çš„ä»£ç è¿˜æ˜¯æœ‰äº›å›°æƒ‘ï¼Œå¤§çº¦æ˜¯è¦ç¡¬ç€å¤´çš®å¾€ä¸‹è¯»å§ã€‚</p>
<p>ä¸è¿‡å¥½åœ¨åœ¨èŠ±è´¹äº†åä¸ªå¤šå°æ—¶çš„æ‘¸ç´¢ï¼Œæ€»ç®—ç†å‡ºäº†ä¸€äº›å¤´ç»ªï¼Œä¹Ÿè§£å†³æ‰äº† SwiGLU å’Œ RMSNorm ç®—å­çš„å¼€è·¯éšœç¢ï¼Œåœ¨ç»§ç»­å¾€ä¸‹åšé¢˜ä¹‹å‰ï¼Œå…ˆå†™ä¸¤ç¯‡åšå®¢æ€»ç»“æ•´ç†å¾—åˆ°çš„ç»éªŒå’Œæ€è·¯ã€‚</p>
<h2 id="ä»»åŠ¡æè¿°"><a href="#ä»»åŠ¡æè¿°" class="headerlink" title="ä»»åŠ¡æè¿°"></a>ä»»åŠ¡æè¿°</h2><p>è¯·åœ¨ <code>src/operators.rs</code> ä¸­å®ç° SwiGLU ç®—å­ï¼Œå…¶å…¬å¼ä¸ºï¼š</p>
<p>$$<br>y&#x3D;silu(x) Ã— y<br>$$</p>
<p>å…¶ä¸­</p>
<p>$$<br>silu(x) &#x3D; sigmoid(x) Ã— x<br>$$</p>
<p>$$<br>sigmoid(x) &#x3D; \frac{1}{1 + e^{-x}}<br>$$</p>
<p>æ³¨æ„ï¼š</p>
<ul>
<li><p>$y$ æ—¢æ˜¯è¾“å…¥ï¼Œä¹Ÿå­˜å‚¨æœ€ç»ˆè¾“å‡ºã€‚</p>
</li>
<li><p>è¯¥ç®—å­æ˜¯element-wiseæ“ä½œè€Œéå‘é‡ç‚¹ä¹˜ï¼Œå³å•æ¬¡è¿ç®—åªæ¶‰åŠè¾“å…¥å’Œè¾“å‡ºå¼ é‡ä¸­å¯¹åº”çš„å…ƒç´ ã€‚</p>
</li>
<li><p>ä½ å¯ä»¥é»˜è®¤è¾“å…¥è¾“å‡ºé•¿åº¦ç›¸åŒï¼Œä¸ç”¨è€ƒè™‘å¹¿æ’­çš„æƒ…å†µã€‚</p>
</li>
<li><p>ç”¨ <code>src/operators.rs</code> ä¸­çš„æµ‹ä¾‹æ£€éªŒä½ çš„å®ç°æ˜¯å¦æ­£ç¡®ã€‚</p>
</li>
</ul>
<h2 id="è§£è¯»-Tensor"><a href="#è§£è¯»-Tensor" class="headerlink" title="è§£è¯» Tensor"></a>è§£è¯» <code>Tensor</code></h2><p>ä»»åŠ¡æè¿°åœ¨æ•°å­¦è¯­è¨€ä¸Šæ˜¯æ¸…æ™°çš„ï¼Œæˆ‘æ‰€æ··ä¹±çš„æ˜¯å¦‚ä½•å°†æ•°å­¦è¯­è¨€è½¬æ¢æˆä¸€å®šæ•°æ®ç»“æ„ä¸‹çš„ Rust ä»£ç è¯­è¨€ã€‚é¦–å…ˆè¦ææ¸…æ¥šä½œä¸º <code>swiglu(y: &amp;mut Tensor&lt;f32&gt;, x: &amp;Tensor&lt;f32&gt;)</code> ä¸­å‚æ•°çš„ç±»å‹ <code>Tensor</code> æ˜¯ä»€ä¹ˆï¼Ÿå®ƒçš„ä»£ç å®ç°æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">Tensor</span>&lt;T&gt; &#123;</span><br><span class="line">	data: Arc&lt;<span class="type">Box</span>&lt;[T]&gt;&gt;,   <span class="comment">// åº•å±‚æ•°æ®å­˜å‚¨</span></span><br><span class="line">	shape: <span class="type">Vec</span>&lt;unsize&gt;,	   <span class="comment">// å½¢çŠ¶ </span></span><br><span class="line">	offset: <span class="type">usize</span>,         <span class="comment">// æ•°æ®åç§»é‡</span></span><br><span class="line">	length: <span class="type">usize</span>,         <span class="comment">// æ•°æ®é•¿åº¦</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­çš„æ³›å‹ã€ç»“æ„ä½“ã€Vecã€usizeæˆ‘éƒ½èƒ½ç†è§£æ˜¯ä»€ä¹ˆï¼Ÿå”¯ç‹¬ <code>Arc&lt;Box&lt;[T]&gt;&gt;</code> è¿™ç§å®ç°ä¸€æ—¶æ²¡æœ‰çœ‹æ˜ç™½ã€‚æ„Ÿè°¢æœ‰ ChatGpt çš„å­˜åœ¨ï¼Œå¤åˆ¶è¿‡å»ç›´æ¥è¿›è¡Œè¯¢é—®ï¼Œå¾—åˆ°äº†æ¸…æ™°çš„è§£ç­”ï¼Œä¸ºæ­¤æˆ‘æ•´ç†äº†ä¸€ç¯‡çŸ¥ä¹æ–‡ç« ï¼š<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/21613395801">è§£è¯»ï¼šArc&gt; - çŸ¥ä¹</a>ã€‚å…¶ä¸­æˆ‘è®¤ä¸ºå¯¹æˆ‘å…³é”®çš„éƒ¨åˆ†æ˜¯ï¼š</p>
<ul>
<li><code>[T]</code> æ˜¯<strong>åŠ¨æ€æ•°ç»„</strong>ï¼Œè¡¨ç¤º<strong>ä¸€ä¸ªé•¿åº¦æœªçŸ¥çš„åˆ‡ç‰‡</strong>ï¼ˆsliceï¼‰ã€‚</li>
<li>å› ä¸ºè¦å­˜å‚¨ ä»»æ„é•¿åº¦çš„æ•°ç»„ï¼Œå¿…é¡»ç”¨åˆ‡ç‰‡ <code>&amp;[T]</code>ï¼Œä½†åˆ‡ç‰‡æœ¬èº«æ²¡æœ‰æ‰€æœ‰æƒï¼Œå› æ­¤ä½¿ç”¨ <code>Box&lt;[T]&gt;</code> åœ¨å †ä¸Šåˆ†é…æ•°æ®å¹¶è·å–æ‰€æœ‰æƒã€‚</li>
<li>ä½¿ç”¨ <code>Arc&lt;T&gt;</code> æ˜¯å› ä¸º <code>Box&lt;T&gt;</code> åªèƒ½æœ‰ä¸€ä¸ªæ‰€æœ‰è€…ï¼Œè€Œå¦‚æœ <code>Tensor&lt;T&gt;</code> çš„å¤šä¸ªå®ä¾‹éœ€è¦å…±äº« <code>data</code> ï¼Œ<code>Box&lt;T&gt;</code> åˆ™ä¸å¤Ÿç”¨ã€‚è€Œ <code>Arc&lt;T&gt;</code> åˆ™å…è®¸å¤šä¸ª <code>Tensor&lt;T&gt;</code> å…±äº«åŒä¸€ä¸ªæ•°æ®ï¼Œå¹¶åœ¨æœ€åä¸€ä¸ª <code>Tensor</code> è¢«é‡Šæ”¾æ—¶æ‰é‡Šæ”¾ <code>data</code> ã€‚</li>
</ul>
<h2 id="Tensor-çš„æ–¹æ³•"><a href="#Tensor-çš„æ–¹æ³•" class="headerlink" title="Tensor çš„æ–¹æ³•"></a><code>Tensor</code> çš„æ–¹æ³•</h2><h3 id="new"><a href="#new" class="headerlink" title="new()"></a><code>new()</code></h3><p>ç”¨äºåˆ›å»ºä¸€ä¸ªæ–°çš„ <code>Tensor</code> å®ä¾‹ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">new</span>(data: <span class="type">Vec</span>&lt;T&gt;, shape: &amp;<span class="type">Vec</span>&lt;<span class="type">usize</span>&gt;) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">length</span> = data.<span class="title function_ invoke__">len</span>();</span><br><span class="line">    Tensor &#123;</span><br><span class="line">        data: Arc::<span class="title function_ invoke__">new</span>(data.<span class="title function_ invoke__">into_boxed_slice</span>().<span class="title function_ invoke__">try_into</span>().<span class="title function_ invoke__">unwrap</span>()),</span><br><span class="line">        shape: shape.<span class="title function_ invoke__">clone</span>(),</span><br><span class="line">        offset: <span class="number">0</span>,</span><br><span class="line">        length: length,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>data: Arc::new(data.into_boxed_slice().try_into().unwrap())</code>ï¼š<ul>
<li><code>data.into_boxed_slice()</code>ï¼šå°† <code>data</code> å‘é‡è½¬æ¢ä¸º <code>Box&lt;[T]&gt;</code> ç±»å‹çš„åŠ¨æ€æ•°ç»„ã€‚</li>
<li><code>try_into().unwrap()</code>ï¼šå°† <code>Box&lt;[T]&gt;</code> è½¬æ¢ä¸º <code>Box&lt;[T]&gt;</code> ç±»å‹ï¼ˆè¿™é‡Œå®é™…ä¸Šæ˜¯åŒä¸€ç±»å‹çš„è½¬æ¢ï¼Œä½† <code>try_into</code> æ˜¯ä¸ºäº†éµå¾ª <code>TryInto</code> ç‰¹æ€§ï¼‰ï¼Œå¹¶ä½¿ç”¨ <code>unwrap</code> æ–¹æ³•å¤„ç†å¯èƒ½çš„é”™è¯¯ï¼ˆåœ¨è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­ï¼Œç”±äºç±»å‹è½¬æ¢æ˜¯ç¡®å®šçš„ï¼Œæ‰€ä»¥ä¸ä¼šå¤±è´¥ï¼‰ã€‚</li>
<li><code>Arc::new(...)</code>ï¼šå°†è½¬æ¢åçš„ <code>Box&lt;[T]&gt;</code> åŒ…è£…åœ¨ <code>Arc</code> ä¸­ï¼Œä»¥ä¾¿åœ¨å¤šä¸ªçº¿ç¨‹é—´å…±äº«æ•°æ®ã€‚</li>
</ul>
</li>
<li><code>shape: shape.clone()</code>ï¼šå…‹éš† <code>shape</code> å¼•ç”¨æ‰€æŒ‡å‘çš„ <code>Vec&lt;usize&gt;</code>ï¼Œå¹¶å°†å…¶èµ‹å€¼ç»™ <code>Tensor</code> å®ä¾‹çš„ <code>shape</code> å­—æ®µã€‚</li>
<li><code>offset: 0</code>ï¼šå°† <code>offset</code> å­—æ®µåˆå§‹åŒ–ä¸º <code>0</code>ï¼Œè¡¨ç¤ºä» <code>data</code> æ•°ç»„çš„èµ·å§‹ä½ç½®å¼€å§‹ã€‚</li>
<li><code>length: length</code>ï¼šå°† <code>length</code> å­—æ®µåˆå§‹åŒ–ä¸ºä¹‹å‰è®¡ç®—çš„ <code>data</code> æ•°ç»„çš„é•¿åº¦ã€‚</li>
</ul>
<h3 id="default"><a href="#default" class="headerlink" title="default()"></a><code>default()</code></h3><p>ç”¨äºåˆ›å»ºä¸€ä¸ªå…·æœ‰æŒ‡å®šå½¢çŠ¶çš„é»˜è®¤ <code>Tensor</code> å®ä¾‹ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">default</span>(shape: &amp;<span class="type">Vec</span>&lt;<span class="type">usize</span>&gt;) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">length</span> = shape.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">product</span>(); <span class="comment">// è¡¨ç¤ºå¼ é‡ä¸­å…ƒç´ çš„æ€»æ•°</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">data</span> = <span class="built_in">vec!</span>[T::<span class="title function_ invoke__">default</span>(); length]; <span class="comment">// åˆ›å»ºäº†ä¸€ä¸ªé•¿åº¦ä¸º length çš„ Vec&lt;T&gt; å‘é‡ data</span></span><br><span class="line">    <span class="keyword">Self</span>::<span class="title function_ invoke__">new</span>(data, shape)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>T::default()</code> æ˜¯ <code>T</code> ç±»å‹çš„é»˜è®¤å€¼ï¼Œè¿™è¦æ±‚ <code>T</code> ç±»å‹å®ç°äº† <code>Default</code> ç‰¹æ€§ã€‚</li>
</ul>
<h3 id="data"><a href="#data" class="headerlink" title="data()"></a><code>data()</code></h3><p>è¿”å›ä¸€ä¸ªæŒ‡å‘ <code>Tensor</code> ä¸­æ•°æ®çš„ä¸å¯å˜åˆ‡ç‰‡</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">data</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;[T] &#123;</span><br><span class="line">    &amp;<span class="keyword">self</span>.data[<span class="keyword">self</span>.offset..][..<span class="keyword">self</span>.length]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>self.data[self.offset..]</code>ï¼š<ul>
<li>è¿™ä¸€æ­¥æ˜¯ä» <code>data</code> æ•°ç»„çš„ <code>offset</code> ä½ç½®å¼€å§‹æˆªå–ï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„åˆ‡ç‰‡ã€‚è¿™ä¸ªæ“ä½œçš„ä½œç”¨æ˜¯è·³è¿‡ <code>data</code> æ•°ç»„ä¸­ <code>offset</code> ä¹‹å‰çš„éƒ¨åˆ†ï¼Œå®šä½åˆ°å¼ é‡æ•°æ®çš„èµ·å§‹ä½ç½®ã€‚</li>
</ul>
</li>
<li><code>[..self.length]</code>ï¼š<ul>
<li>å¯¹ä¸Šä¸€æ­¥ç”Ÿæˆçš„åˆ‡ç‰‡å†æ¬¡è¿›è¡Œæˆªå–ï¼Œå–å…¶å‰ <code>length</code> ä¸ªå…ƒç´ ã€‚è¿™æ ·åšæ˜¯ä¸ºäº†ç¡®ä¿æˆªå–å‡ºæ¥çš„åˆ‡ç‰‡é•¿åº¦æ­£å¥½ç­‰äºå¼ é‡ä¸­å…ƒç´ çš„æ€»æ•°ã€‚</li>
</ul>
</li>
</ul>
<h3 id="data-mut"><a href="#data-mut" class="headerlink" title="data_mut()"></a><code>data_mut()</code></h3><p>è¿”å›ä¸€ä¸ªæŒ‡å‘ <code>Tensor</code> ä¸­æ•°æ®çš„å¯å˜åˆ‡ç‰‡</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">unsafe</span> <span class="keyword">fn</span> <span class="title function_">data_mut</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="keyword">mut</span> [T] &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">ptr</span> = <span class="keyword">self</span>.data.<span class="title function_ invoke__">as_ptr</span>().<span class="title function_ invoke__">add</span>(<span class="keyword">self</span>.offset) <span class="keyword">as</span> *<span class="keyword">mut</span> T;</span><br><span class="line">    slice::<span class="title function_ invoke__">from_raw_parts_mut</span>(ptr, <span class="keyword">self</span>.length)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>unsafe</code>ï¼šæ ‡è®°è¯¥æ–¹æ³•ä¸ºä¸å®‰å…¨æ–¹æ³•ï¼Œå› ä¸ºå®ƒæ¶‰åŠåˆ°æŒ‡é’ˆæ“ä½œï¼Œéœ€è¦è°ƒç”¨è€…è‡ªè¡Œç¡®ä¿æ“ä½œçš„å®‰å…¨æ€§ã€‚</li>
<li><code>self.data.as_ptr()</code>ï¼šè°ƒç”¨ <code>self.data</code> çš„ <code>as_ptr</code> æ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ªæŒ‡å‘ <code>self.data</code> æ•°ç»„é¦–å…ƒç´ çš„ä¸å¯å˜åŸå§‹æŒ‡é’ˆ <code>*const T</code>ã€‚</li>
<li><code>.add(self.offset)</code>ï¼šè°ƒç”¨ <code>add</code> æ–¹æ³•ï¼Œå°†æŒ‡é’ˆåç§» <code>self.offset</code> ä¸ªå…ƒç´ çš„ä½ç½®ï¼Œå¾—åˆ°ä¸€ä¸ªæŒ‡å‘ <code>Tensor</code> æ•°æ®èµ·å§‹ä½ç½®çš„æŒ‡é’ˆã€‚</li>
<li><code>as *mut T</code>ï¼šå°†ä¸å¯å˜æŒ‡é’ˆè½¬æ¢ä¸ºå¯å˜æŒ‡é’ˆ <code>*mut T</code>ï¼Œä»¥ä¾¿åç»­åˆ›å»ºå¯å˜åˆ‡ç‰‡ã€‚</li>
<li><code>slice::from_raw_parts_mut</code>ï¼šè¿™æ˜¯ <code>std::slice</code> æ¨¡å—ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œç”¨äºä»ä¸€ä¸ªå¯å˜æŒ‡é’ˆå’Œé•¿åº¦åˆ›å»ºä¸€ä¸ªå¯å˜åˆ‡ç‰‡ã€‚<ul>
<li><code>ptr</code>ï¼šä½œä¸ºå‚æ•°ä¼ é€’ç»™ <code>from_raw_parts_mut</code> å‡½æ•°çš„å¯å˜æŒ‡é’ˆï¼ŒæŒ‡å‘ <code>Tensor</code> æ•°æ®çš„èµ·å§‹ä½ç½®ã€‚</li>
<li><code>self.length</code>ï¼šä½œä¸ºå‚æ•°ä¼ é€’ç»™ <code>from_raw_parts_mut</code> å‡½æ•°çš„é•¿åº¦ï¼Œè¡¨ç¤ºåˆ‡ç‰‡çš„é•¿åº¦ã€‚</li>
</ul>
</li>
</ul>
<h3 id="shape"><a href="#shape" class="headerlink" title="shape()"></a><code>shape()</code></h3><p>è¿”å› <code>Tensor</code> å®ä¾‹çš„ <code>shape</code> å­—æ®µçš„ä¸å¯å˜å¼•ç”¨</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">shape</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> &amp;<span class="type">Vec</span>&lt;<span class="type">usize</span>&gt; &#123;</span><br><span class="line">    &amp;<span class="keyword">self</span>.shape</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>&amp;self</code> è®© <code>shape</code> æ–¹æ³•å¯ä»¥è®¿é—® <code>Tensor</code> å®ä¾‹ï¼Œè€Œ <code>&amp;self.shape</code> åˆ™æ˜¯ä¸ºäº†è¿”å› <code>shape</code> å­—æ®µçš„ä¸å¯å˜å¼•ç”¨ã€‚</li>
</ul>
<h3 id="size"><a href="#size" class="headerlink" title="size()"></a><code>size()</code></h3><p>è¿”å› <code>Tensor</code> å®ä¾‹ä¸­å…ƒç´ çš„æ€»æ•°</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">size</span>(&amp;<span class="keyword">self</span>) <span class="punctuation">-&gt;</span> <span class="type">usize</span> &#123;</span><br><span class="line">    <span class="keyword">self</span>.length</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="reshape"><a href="#reshape" class="headerlink" title="reshape()"></a><code>reshape()</code></h3><p>åœ¨ä¸æ”¹å˜å¼ é‡ä¸­å…ƒç´ æ€»æ•°çš„å‰æä¸‹ï¼Œå°†å¼ é‡é‡æ–°è§£é‡Šä¸ºä¸€ä¸ªæ–°çš„å½¢çŠ¶</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">reshape</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, new_shape: &amp;<span class="type">Vec</span>&lt;<span class="type">usize</span>&gt;) <span class="punctuation">-&gt;</span> &amp;<span class="keyword">mut</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">new_length</span>: <span class="type">usize</span> = new_shape.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">product</span>();</span><br><span class="line">    <span class="keyword">if</span> new_length != <span class="keyword">self</span>.length &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">old_shape</span> = <span class="keyword">self</span>.shape.<span class="title function_ invoke__">clone</span>();</span><br><span class="line">        <span class="built_in">panic!</span>(<span class="string">&quot;New shape &#123;new_shape:?&#125; does not match tensor of &#123;old_shape:?&#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">self</span>.shape = new_shape.<span class="title function_ invoke__">clone</span>();</span><br><span class="line">    <span class="keyword">self</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>&amp;self</code> åœºæ™¯ï¼š<code>self</code> æ˜¯ä¸å¯å˜å¼•ç”¨ï¼Œè‹¥è¦è¿”å› <code>self</code> ä¸­æŸä¸ªå­—æ®µçš„å¼•ç”¨ï¼Œéœ€è¦ç”¨ <code>&amp;</code> æ¥è·å–è¯¥å­—æ®µçš„ä¸å¯å˜å¼•ç”¨ã€‚</li>
<li><code>&amp;mut self</code> åœºæ™¯ï¼š<code>self</code> æ˜¯å¯å˜å¼•ç”¨ï¼Œè‹¥è¦è¿”å› <code>self</code> æœ¬èº«çš„å¯å˜å¼•ç”¨ï¼Œç›´æ¥è¿”å› <code>self</code> å³å¯ã€‚</li>
</ul>
<h3 id="slice"><a href="#slice" class="headerlink" title="slice()"></a><code>slice()</code></h3><p>ä»ç°æœ‰çš„ Tensor ä¸­åˆ‡å‡ºä¸€ä¸ªå­å¼ é‡</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">slice</span>(&amp;<span class="keyword">self</span>, start: <span class="type">usize</span>, shape: &amp;<span class="type">Vec</span>&lt;<span class="type">usize</span>&gt;) <span class="punctuation">-&gt;</span> <span class="keyword">Self</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">new_length</span>: <span class="type">usize</span> = shape.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">product</span>();</span><br><span class="line">    <span class="built_in">assert!</span>(<span class="keyword">self</span>.offset + start + new_length &lt;= <span class="keyword">self</span>.length);</span><br><span class="line">    Tensor &#123;</span><br><span class="line">        data: <span class="keyword">self</span>.data.<span class="title function_ invoke__">clone</span>(),</span><br><span class="line">        shape: shape.<span class="title function_ invoke__">clone</span>(),</span><br><span class="line">        offset: <span class="keyword">self</span>.offset + start,</span><br><span class="line">        length: new_length,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>ä½¿ç”¨ <code>assert!</code> å®è¿›è¡Œæ–­è¨€æ£€æŸ¥ï¼Œç¡®ä¿åˆ‡ç‰‡æ“ä½œä¸ä¼šè¶Šç•Œã€‚<code>self.offset + start + new_length</code> è¡¨ç¤ºåˆ‡ç‰‡æ“ä½œç»“æŸçš„ä½ç½®ï¼Œå¦‚æœè¿™ä¸ªä½ç½®è¶…è¿‡äº†å½“å‰ <code>Tensor</code> çš„å…ƒç´ æ€»æ•° <code>self.length</code>ï¼Œç¨‹åºä¼šè§¦å‘æ–­è¨€é”™è¯¯å¹¶ç»ˆæ­¢ã€‚</li>
</ul>
<h3 id="close-to"><a href="#close-to" class="headerlink" title="close_to()"></a><code>close_to()</code></h3><p>è¯¥æ–¹æ³•ç”¨äºåˆ¤æ–­ä¸¤ä¸ª <code>Tensor&lt;f32&gt;</code> å®ä¾‹åœ¨æ•°å€¼ä¸Šæ˜¯å¦è¶³å¤Ÿæ¥è¿‘ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">close_to</span>(&amp;<span class="keyword">self</span>, other: &amp;<span class="keyword">Self</span>, rel: <span class="type">f32</span>) <span class="punctuation">-&gt;</span> <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">self</span>.<span class="title function_ invoke__">shape</span>() != other.<span class="title function_ invoke__">shape</span>() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">a</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">data</span>();</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">b</span> = other.<span class="title function_ invoke__">data</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> a.<span class="title function_ invoke__">iter</span>().<span class="title function_ invoke__">zip</span>(b).<span class="title function_ invoke__">all</span>(|(x, y)| <span class="title function_ invoke__">float_eq</span>(x, y, rel));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>rel: f32</code>ï¼šæ¥æ”¶ä¸€ä¸ª <code>f32</code> ç±»å‹çš„ç›¸å¯¹å®¹å·®å‚æ•°ï¼Œç”¨äºåˆ¤æ–­ä¸¤ä¸ªæµ®ç‚¹æ•°æ˜¯å¦è¶³å¤Ÿæ¥è¿‘ã€‚</li>
<li>ä½¿ç”¨ <code>iter().zip()</code> æ–¹æ³•å°†ä¸¤ä¸ªæ•°æ®åˆ‡ç‰‡ä¸­çš„å…ƒç´ ä¸€ä¸€å¯¹åº”èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªå…ƒç´ å¯¹çš„è¿­ä»£å™¨ã€‚</li>
<li>å¯¹è¿™ä¸ªè¿­ä»£å™¨ä¸­çš„æ¯ä¸ªå…ƒç´ å¯¹ <code>(x, y)</code>ï¼Œè°ƒç”¨ <code>float_eq</code> å‡½æ•°ï¼Œåˆ¤æ–­å®ƒä»¬æ˜¯å¦è¶³å¤Ÿæ¥è¿‘ã€‚<code>float_eq</code> å‡½æ•°æ ¹æ®ä¼ å…¥çš„ç›¸å¯¹å®¹å·® <code>rel</code> æ¥åˆ¤æ–­ä¸¤ä¸ªæµ®ç‚¹æ•°æ˜¯å¦è¶³å¤Ÿæ¥è¿‘ã€‚</li>
<li><code>all</code> æ–¹æ³•ç”¨äºæ£€æŸ¥è¿­ä»£å™¨ä¸­çš„æ‰€æœ‰å…ƒç´ å¯¹æ˜¯å¦éƒ½æ»¡è¶³ <code>float_eq</code> å‡½æ•°çš„æ¡ä»¶ã€‚å¦‚æœæ‰€æœ‰å…ƒç´ å¯¹éƒ½è¶³å¤Ÿæ¥è¿‘ï¼Œåˆ™è¿”å› <code>true</code>ï¼›å¦åˆ™è¿”å› <code>false</code>ã€‚</li>
</ul>
<h3 id="print"><a href="#print" class="headerlink" title="print()"></a><code>print()</code></h3><p>æ‰“å° Tensor çš„å½¢çŠ¶ã€åç§»é‡ã€é•¿åº¦ä»¥åŠå…¶ä¸­çš„æ•°æ®ï¼Œè¿™ä¸ªæ–¹æ³•å¯¹åé¢çš„è°ƒè¯•å¾ˆæœ‰å¸®åŠ©ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">print</span>(&amp;<span class="keyword">self</span>)&#123;</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;shpae: &#123;:?&#125;, offset: &#123;&#125;, length: &#123;&#125;&quot;</span>, <span class="keyword">self</span>.shape, <span class="keyword">self</span>.offset, <span class="keyword">self</span>.length);</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">dim</span> = <span class="keyword">self</span>.<span class="title function_ invoke__">shape</span>()[<span class="keyword">self</span>.<span class="title function_ invoke__">shape</span>().<span class="title function_ invoke__">len</span>() - <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">batch</span> = <span class="keyword">self</span>.length / dim;</span><br><span class="line">    <span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="number">0</span>..batch &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="variable">start</span> = i * dim;</span><br><span class="line">        <span class="built_in">println!</span>(<span class="string">&quot;&#123;:?&#125;&quot;</span>, &amp;<span class="keyword">self</span>.<span class="title function_ invoke__">data</span>()[start..][..dim]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>é€šè¿‡ <code>self.shape().len() - 1</code> ç´¢å¼•è·å–æœ€åä¸€ä¸ªç»´åº¦çš„å¤§å°ã€‚</li>
<li><code>self.length</code> è¡¨ç¤º <code>Tensor</code> ä¸­å…ƒç´ çš„æ€»æ•°ï¼Œå°†å…¶é™¤ä»¥æœ€åä¸€ä¸ªç»´åº¦çš„å¤§å° <code>dim</code>ï¼Œå¾—åˆ°æ‰¹æ¬¡æ•°é‡ã€‚</li>
<li><code>let start = i * dim;</code> è®¡ç®—æ¯ä¸ªæ‰¹æ¬¡æ•°æ®åœ¨ <code>Tensor</code> ä¸­çš„èµ·å§‹ä½ç½®ã€‚</li>
<li><code>&amp;self.data()[start..][..dim]</code> ä» <code>Tensor</code> çš„æ•°æ®ä¸­æˆªå–å½“å‰æ‰¹æ¬¡çš„æ•°æ®ï¼Œ<code>self.data()</code> æ–¹æ³•è¿”å› <code>Tensor</code> ä¸­å­˜å‚¨çš„æ•°æ®çš„ä¸å¯å˜åˆ‡ç‰‡ï¼Œé€šè¿‡åˆ‡ç‰‡æ“ä½œ <code>[start..][..dim]</code> æˆªå–å½“å‰æ‰¹æ¬¡çš„æ•°æ®ã€‚</li>
</ul>
<h2 id="swiglu-ç®—å­çš„å®ç°"><a href="#swiglu-ç®—å­çš„å®ç°" class="headerlink" title="swiglu ç®—å­çš„å®ç°"></a>swiglu ç®—å­çš„å®ç°</h2><p>é€šè¿‡åŒæ—¶è¿­ä»£ <code>_y</code> æ•°ç»„å’Œ <code>_x</code> æ•°ç»„è¿›è¡Œ <code>element-wise</code> æ“ä½œï¼Œç„¶åæ‰§è¡Œå¯¹è¿­ä»£çš„å˜é‡æ‰§è¡Œä»»åŠ¡æè¿°çš„æ‰€è¿°çš„è®¡ç®—å…¬å¼ã€‚è¿™é‡Œæˆ‘çš„å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// å®ç° SwiGLU æ¿€æ´»å‡½æ•°ï¼Œå³ y = silu(x) * yï¼Œè¿™æ˜¯ä¸€ä¸ªé€å…ƒç´ æ“ä½œ</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// # å‚æ•°</span></span><br><span class="line"><span class="comment">/// - `y`: å¯å˜çš„ `Tensor&lt;f32&gt;` å¼•ç”¨ï¼Œç”¨äºå­˜å‚¨è®¡ç®—ç»“æœï¼Œä¼šè¢«ä¿®æ”¹ã€‚</span></span><br><span class="line"><span class="comment">/// - `x`: ä¸å¯å˜çš„ `Tensor&lt;f32&gt;` å¼•ç”¨ï¼Œä½œä¸ºè¾“å…¥æ•°æ®ã€‚</span></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">swiglu</span>(y: &amp;<span class="keyword">mut</span> Tensor&lt;<span class="type">f32</span>&gt;, x: &amp;Tensor&lt;<span class="type">f32</span>&gt;) &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">len</span> = y.<span class="title function_ invoke__">size</span>();</span><br><span class="line">    <span class="comment">// æ–­è¨€ y å’Œ x å¼ é‡çš„å…ƒç´ æ•°é‡ç›¸åŒï¼Œç¡®ä¿ element-wise æ“ä½œä¸ä¼šè¶Šç•Œ</span></span><br><span class="line">    <span class="built_in">assert!</span>(len == x.<span class="title function_ invoke__">size</span>());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»¥ä¸å®‰å…¨çš„æ–¹å¼è·å– y å¼ é‡æ•°æ®çš„å¯å˜åˆ‡ç‰‡</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable">_y</span> = <span class="keyword">unsafe</span> &#123; y.<span class="title function_ invoke__">data_mut</span>() &#125;;</span><br><span class="line">    <span class="keyword">let</span> <span class="variable">_x</span> = x.<span class="title function_ invoke__">data</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (mut_num_y, num_x) <span class="keyword">in</span> _y.<span class="title function_ invoke__">iter_mut</span>().<span class="title function_ invoke__">zip</span>(_x.<span class="title function_ invoke__">iter</span>()) &#123;</span><br><span class="line">        <span class="comment">// è®¡ç®— x å…ƒç´ çš„ SiLU æ¿€æ´»å€¼</span></span><br><span class="line">        <span class="keyword">let</span> <span class="variable">silu_x</span> = num_x * (<span class="number">1</span>. / (<span class="number">1</span>. + (-num_x).<span class="title function_ invoke__">exp</span>()));</span><br><span class="line">        <span class="comment">// å°† y å…ƒç´ ä¹˜ä»¥å¯¹åº”çš„ SiLU æ¿€æ´»å€¼</span></span><br><span class="line">        *mut_num_y *= silu_x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æ€»ç»“æŠ€å·§"><a href="#æ€»ç»“æŠ€å·§" class="headerlink" title="æ€»ç»“æŠ€å·§"></a>æ€»ç»“æŠ€å·§</h2><ol>
<li>é€šè¿‡IDEçš„æç¤ºï¼Œå¤šè§‚å¯Ÿå‚æ•°ã€å˜é‡çš„æ•°æ®ç±»å‹å˜åŒ–ï¼Œç±»å‹çš„è½¬æ¢æ˜¯è§£é¢˜çš„ä¸»è¦æ€è·¯ã€‚</li>
<li>å€Ÿç”¨ <code>println!</code> å’Œ<code>Tensor</code> çš„ <code>print</code> æ–¹æ³•ï¼Œåœ¨å…³é”®ä½ç½®è¿›è¡Œæ‰“å°ï¼Œè§‚å¯Ÿç¨‹åºæ‰§è¡Œä¸æ€è·¯è®¾è®¡çš„å·®å¼‚ã€‚</li>
</ol>
</div>
    </div>

    <div class="post-meta">
        <i>
        
            <span>2025-02-12</span>
            
                <span>è¯¥ç¯‡æ–‡ç« è¢« meng.wang</span>
            
            
                <span>æ‰“ä¸Šæ ‡ç­¾:
                    
                    
                        <a href='/MyBlog/tags/rust/'>
                            rust
                        </a>
                    
                        <a href='/MyBlog/tags/InfiniTensor/'>
                            InfiniTensor
                        </a>
                    
                </span>
             
             
                <span>å½’ä¸ºåˆ†ç±»:
                    
                    
                        <a href='/MyBlog/categories/%E9%A1%B9%E7%9B%AE/'>
                            é¡¹ç›®
                        </a>
                    
                </span>
            
        
        </i>
    </div>
    <br>
    
    
        
            
    
            <div class="post-footer-pre-next">
                
                    <span>ä¸Šä¸€ç¯‡ï¼š<a href='/MyBlog/posts/8147e6c8.html'>å®ç°RMSNormç®—å­</a></span>
                

                
                    <span class="post-footer-pre-next-last-span-right">ä¸‹ä¸€ç¯‡ï¼š<a href="/MyBlog/posts/77eefbae.html">è§£è¯»ï¼šArc&lt;Box&lt;[T]&gt;&gt;</a>
                    </span>
                
            </div>
    
        
    

     
</div>



                                      
                    
                    
                    <div class="footer">
    
        <span> 
            Â© 1949-2025 China 

            
                

            
                
                    / <a href="/MyBlog/friends/"> å‹é“¾ </a>
                

            
                
                    / <a href="/MyBlog/support/"> æ”¯æŒ </a>
                

            
        </span>
       
    
</div>



<!--è¿™æ˜¯æŒ‡ä¸€æ¡çº¿å¾€ä¸‹çš„å†…å®¹-->
<div class="footer-last">
    
            <span>ğŸŒŠçœ‹è¿‡å¤§æµ·çš„äººä¸ä¼šå¿˜è®°æµ·çš„å¹¿é˜”ğŸŒŠ</span>
            
                <span class="footer-last-span-right"><i>æœ¬ç«™ç”±<a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/index.html">Hexo</a>é©±åŠ¨ï½œä½¿ç”¨<a target="_blank" rel="noopener" href="https://github.com/HiNinoJay/hexo-theme-A4">Hexo-theme-A4</a>ä¸»é¢˜</i></span>
            
    
</div>


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>

    <!--ç›®å½•-->
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tocify/1.9.0/javascripts/jquery.tocify.min.js" type="text/javascript" ></script>
        
<script src="/MyBlog/js/toc.js"></script>

    

    
<script src="/MyBlog/js/randomHeaderContent.js"></script>

    <!--å›åˆ°é¡¶éƒ¨æŒ‰é’®-->
    
        
<script src="/MyBlog/js/returnToTop.js"></script>

    

    
        
<script src="/MyBlog/js/returnToLastPage.js"></script>

    





<script src="/MyBlog/js/lightgallery/lightgallery.umd.min.js"></script>



<script src="/MyBlog/js/lightgallery/plugins/lg-thumbnail.umd.min.js"></script>



<script src="/MyBlog/js/lightgallery/plugins/lg-fullscreen.umd.min.js"></script>


<script src="/MyBlog/js/lightgallery/plugins/lg-autoplay.umd.min.js"></script>


<script src="/MyBlog/js/lightgallery/plugins/lg-zoom.umd.min.js"></script>


<script src="/MyBlog/js/lightgallery/plugins/lg-rotate.umd.min.js"></script>


<script src="/MyBlog/js/lightgallery/plugins/lg-paper.umd.min.js"></script>




<script type="text/javascript">
     
    if (typeof lightGallery !== "undefined") {
        var options1 = {
            selector: '.gallery-item',
            plugins: [lgThumbnail, lgFullscreen, lgAutoplay, lgZoom, lgRotate, lgPager], // å¯ç”¨æ’ä»¶
            thumbnail: true,          // æ˜¾ç¤ºç¼©ç•¥å›¾
            zoom: true,               // å¯ç”¨ç¼©æ”¾åŠŸ
            rotate: true,             // å¯ç”¨æ—‹è½¬åŠŸèƒ½èƒ½
            autoplay: true,        // å¯ç”¨è‡ªåŠ¨æ’­æ”¾åŠŸèƒ½
            fullScreen: true,      // å¯ç”¨å…¨å±åŠŸèƒ½
            pager: false, //é¡µç ,
            zoomFromOrigin: true,   // ä»åŸå§‹ä½ç½®ç¼©æ”¾
            actualSize: true,       // å¯ç”¨æŸ¥çœ‹å®é™…å¤§å°çš„åŠŸèƒ½
            enableZoomAfter: 300,    // å»¶è¿Ÿç¼©æ”¾ï¼Œç¡®ä¿å›¾ç‰‡åŠ è½½å®Œæˆåå¯ç¼©æ”¾
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options1); // ä¿®å¤é€‰æ‹©å™¨
    }
    
</script>


    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script> 

                </div>
            
            
                <!-- å›åˆ°é¡¶éƒ¨çš„æŒ‰é’®-->  
                <div class="progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
            
                <!-- è¿”å›çš„æŒ‰é’®-->  
                <div class="return-to-last-progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
    </body>
</html>
<script src="/MyBlog/js/emojiHandler.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    wrapEmojis('.paper');
  });
</script>